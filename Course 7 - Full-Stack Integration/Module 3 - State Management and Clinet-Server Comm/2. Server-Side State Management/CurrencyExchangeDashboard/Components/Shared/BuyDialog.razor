@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
            Buy Currency
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudSelect T="string" @bind-Value="_selectedCurrency"
                   Label="Currency to Buy"
                   Variant="Variant.Outlined"
                   AnchorOrigin="Origin.BottomCenter"
                   Class="mb-4">
            @foreach (var currency in Currencies.Where(c => c != BaseCurrency))
            {
                <MudSelectItem Value="@currency">@currency</MudSelectItem>
            }
        </MudSelect>

        <MudNumericField T="decimal" @bind-Value="_amountInBase"
                         Label="@($"Amount to Spend ({BaseCurrency})")"
                         Variant="Variant.Outlined"
                         Min="0.01M"
                         Immediate="true"
                         Class="mb-4" />

        @if (!string.IsNullOrEmpty(_selectedCurrency) && _amountInBase > 0)
        {
            var rate = GetRate(_selectedCurrency);
            var willReceive = _amountInBase * rate;

            <MudAlert Severity="Severity.Info" Class="mb-4">
                <MudText>Rate: 1 @BaseCurrency = @rate.ToString("F4") @_selectedCurrency</MudText>
                <MudText Typo="Typo.h6" Class="mt-2">
                    You will receive: @willReceive.ToString("N4") @_selectedCurrency
                </MudText>
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Success"
                   Variant="Variant.Filled"
                   OnClick="Submit"
                   Disabled="@(!IsValid())">
            Buy
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public List<string> Currencies { get; set; } = [];

    [Parameter]
    public string BaseCurrency { get; set; } = "USD";

    [Parameter]
    public Dictionary<string, decimal> Rates { get; set; } = new();

    private string _selectedCurrency = "";
    private decimal _amountInBase;

    private decimal GetRate(string currency)
    {
        return Rates.TryGetValue(currency, out var rate) ? rate : 0;
    }

    private bool IsValid()
    {
        return !string.IsNullOrEmpty(_selectedCurrency)
               && _amountInBase > 0
               && GetRate(_selectedCurrency) > 0;
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit()
    {
        if (!IsValid())
        {
            Snackbar.Add("Please fill all fields correctly", Severity.Warning);
            return;
        }

        var rate = GetRate(_selectedCurrency);
        var amount = _amountInBase * rate;

        var transaction = new Transaction(
            TransactionType.Buy,
            _selectedCurrency,
            amount,
            rate,
            _amountInBase,
            DateTime.UtcNow
        );

        MudDialog.Close(DialogResult.Ok(transaction));
    }
}
