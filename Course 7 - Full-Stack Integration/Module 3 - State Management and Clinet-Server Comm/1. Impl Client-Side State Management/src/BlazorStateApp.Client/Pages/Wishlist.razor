@page "/wishlist"
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IDispatcher Dispatcher

<div class="alert alert-danger mb-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-info-circle fs-4 me-3"></i>
        <div>
            <strong>Local Storage Demo</strong>
            <p class="mb-0 small">Your wishlist is saved locally and persists between sessions.</p>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-heart-fill me-2"></i>My Wishlist
        </h5>
        @if (_wishlist.Count > 0)
        {
            <span class="badge bg-light text-dark">@_wishlist.Count items</span>
        }
    </div>
    <div class="card-body">
        @if (_isLoading)
        {
            <div class="text-center py-4">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (_wishlist.Count == 0)
        {
            <div class="text-center text-muted py-5">
                <i class="bi bi-heart display-1"></i>
                <h5 class="mt-3">Your wishlist is empty</h5>
                <p class="small">Click the heart icon on products to add them here</p>
                <a href="/" class="btn btn-outline-danger">
                    <i class="bi bi-arrow-left me-1"></i>Browse Products
                </a>
            </div>
        }
        else
        {
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3 mb-4">
                @foreach (var productName in _wishlist)
                {
                    var product = ProductCatalog.GetByName(productName);
                    if (product != null)
                    {
                        <div class="col">
                            <div class="card h-100 border-danger">
                                <div class="card-body text-center position-relative">
                                    <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-1"
                                            @onclick="() => RemoveFromWishlist(productName)"
                                            title="Remove">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <div class="display-4 mb-2">@product.Icon</div>
                                    <h6 class="card-title mb-1">@product.Name</h6>
                                    <span class="badge bg-secondary mb-2">@product.Category</span>
                                    <p class="h5 text-primary mb-3">$@product.Price.ToString("F2")</p>
                                    <button class="btn btn-primary btn-sm w-100"
                                            @onclick="() => AddToCart(product)">
                                        <i class="bi bi-cart-plus me-1"></i>Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
            <div class="text-end">
                <button class="btn btn-outline-danger btn-sm" @onclick="ClearWishlist">
                    <i class="bi bi-trash me-1"></i>Clear Wishlist
                </button>
            </div>
        }
    </div>
</div>

<div class="card shadow-sm bg-body-tertiary mt-4">
    <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <small class="text-muted">
                <i class="bi bi-hdd me-1"></i>
                Wishlist stored in <strong>LocalStorage</strong> (persists between sessions)
            </small>
            <button class="btn btn-outline-danger btn-sm" @onclick="ClearWishlist">
                <i class="bi bi-trash me-1"></i>Clear Local Data
            </button>
        </div>
    </div>
</div>

@code {
    private const string WishlistKey = "wishlist";

    private List<string> _wishlist = new();
    private bool _isLoading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _wishlist = await LocalStorage.GetItemAsync<List<string>>(WishlistKey) ?? new();
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RemoveFromWishlist(string productName)
    {
        _wishlist.Remove(productName);
        await LocalStorage.SetItemAsync(WishlistKey, _wishlist);
    }

    private async Task ClearWishlist()
    {
        _wishlist.Clear();
        await LocalStorage.RemoveItemAsync(WishlistKey);
    }

    private void AddToCart(Product product) =>
        Dispatcher.Dispatch(new AddToCartAction(product.Name, product.Price, Category: product.Category));
}
